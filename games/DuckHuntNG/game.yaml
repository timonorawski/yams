# yaml-language-server: $schema=../../schemas/game.schema.json
# DuckHunt NextGen - YAML-driven duck hunting game
#
# This demonstrates the declarative game engine with:
# - Entity transforms (duck_flying -> duck_hit -> duck_falling)
# - on_hit input mapping (click on duck to hit it)
# - on_update transforms with age conditions (timed transitions)
# - Reusable behaviors (bounce, gravity)

name: "Duck Hunt NG"
description: "YAML-driven duck hunting game"
version: "1.0.0"
author: "AMS Team"

screen_width: 800
screen_height: 600
background_color: [135, 206, 235]  # Sky blue

defaults:
  lives: 3

# Win when score target reached (or time survives, etc.)
win_condition: reach_score
win_target: 1000

# =============================================================================
# Assets - Sprite Sheet Definitions
# =============================================================================
# Sprite sheet: assets/sprites.png
# Layout: Dog rows (0-1), then duck rows (green=2, blue=3, red=4)
# Each duck row: 3 right-flight, 3 up-right, 1 hit, 4 falling
# Transparent color: [159, 227, 163] (light green background)

assets:
  sprites:
    # Green duck sprites (row at y=126)
    green_right_1:
      file: sprites.png
      x: 7
      y: 126
      width: 37
      height: 41
      transparent: [159, 227, 163]
    green_right_2:
      file: sprites.png
      x: 48
      y: 126
      width: 37
      height: 41
      transparent: [159, 227, 163]
    green_right_3:
      file: sprites.png
      x: 88
      y: 126
      width: 37
      height: 41
      transparent: [159, 227, 163]
    green_up_1:
      file: sprites.png
      x: 134
      y: 126
      width: 35
      height: 41
      transparent: [159, 227, 163]
    green_up_2:
      file: sprites.png
      x: 168
      y: 126
      width: 35
      height: 41
      transparent: [159, 227, 163]
    green_up_3:
      file: sprites.png
      x: 202
      y: 126
      width: 35
      height: 41
      transparent: [159, 227, 163]
    green_hit:
      file: sprites.png
      x: 236
      y: 126
      width: 35
      height: 41
      transparent: [159, 227, 163]
    green_fall_1:
      file: sprites.png
      x: 279
      y: 126
      width: 22
      height: 41
      transparent: [159, 227, 163]
    green_fall_2:
      file: sprites.png
      x: 302
      y: 126
      width: 22
      height: 41
      transparent: [159, 227, 163]

    # Green duck LEFT sprites (flipped from right)
    green_left_1:
      file: sprites.png
      x: 7
      y: 126
      width: 37
      height: 41
      transparent: [159, 227, 163]
      flip_x: true
    green_left_2:
      file: sprites.png
      x: 48
      y: 126
      width: 37
      height: 41
      transparent: [159, 227, 163]
      flip_x: true
    green_left_3:
      file: sprites.png
      x: 88
      y: 126
      width: 37
      height: 41
      transparent: [159, 227, 163]
      flip_x: true

    # Green duck UP_LEFT sprites (flipped from up_right)
    green_up_left_1:
      file: sprites.png
      x: 134
      y: 126
      width: 35
      height: 41
      transparent: [159, 227, 163]
      flip_x: true
    green_up_left_2:
      file: sprites.png
      x: 168
      y: 126
      width: 35
      height: 41
      transparent: [159, 227, 163]
      flip_x: true
    green_up_left_3:
      file: sprites.png
      x: 202
      y: 126
      width: 35
      height: 41
      transparent: [159, 227, 163]
      flip_x: true

    # Blue duck sprites (row at y=168)
    blue_right_1:
      file: sprites.png
      x: 7
      y: 168
      width: 37
      height: 41
      transparent: [159, 227, 163]
    blue_left_1:
      file: sprites.png
      x: 7
      y: 168
      width: 37
      height: 41
      transparent: [159, 227, 163]
      flip_x: true
    blue_hit:
      file: sprites.png
      x: 236
      y: 168
      width: 35
      height: 41
      transparent: [159, 227, 163]
    blue_fall_1:
      file: sprites.png
      x: 279
      y: 168
      width: 22
      height: 41
      transparent: [159, 227, 163]

    # Red duck sprites (row at y=210)
    red_right_1:
      file: sprites.png
      x: 7
      y: 210
      width: 37
      height: 41
      transparent: [159, 227, 163]
    red_left_1:
      file: sprites.png
      x: 7
      y: 210
      width: 37
      height: 41
      transparent: [159, 227, 163]
      flip_x: true
    red_hit:
      file: sprites.png
      x: 236
      y: 210
      width: 35
      height: 41
      transparent: [159, 227, 163]
    red_fall_1:
      file: sprites.png
      x: 279
      y: 210
      width: 22
      height: 41
      transparent: [159, 227, 163]

# =============================================================================
# Entity Types
# =============================================================================

entity_types:

  # ---------------------------------------------------------------------------
  # Duck - Flying state
  # ---------------------------------------------------------------------------
  # Moves with velocity, bounces off walls in upper portion of screen.
  # When clicked (on_hit), transforms to duck_hit.

  duck_flying:
    width: 37
    height: 41
    color: green
    sprite: green_right_1
    behaviors: [bounce, animate]
    behavior_config:
      bounce:
        walls: top_sides
        min_y: 50
        max_y: 0.6
      animate:
        frames: 3
        fps: 8
    tags: [duck, target]
    render:
      # Heading: 0° = up, 90° = right, 180° = down, 270° = left
      # Sprite names use {frame} template (1, 2, 3)
      # Up-right (0° - 90°): use up-right sprite
      - shape: sprite
        sprite: green_up_{frame}
        when:
          property: heading
          compare: between
          min: 0
          value: 90
      # Right-down (90° - 180°): use horizontal right sprite
      - shape: sprite
        sprite: green_right_{frame}
        when:
          property: heading
          compare: between
          min: 90
          value: 180
      # Down-left (180° - 270°): use horizontal left sprite
      - shape: sprite
        sprite: green_left_{frame}
        when:
          property: heading
          compare: between
          min: 180
          value: 270
      # Up-left (270° - 360°): use up-left sprite
      - shape: sprite
        sprite: green_up_left_{frame}
        when:
          property: heading
          compare: between
          min: 270
          value: 360

  # ---------------------------------------------------------------------------
  # Duck - Hit state (pause before falling)
  # ---------------------------------------------------------------------------
  # Static, shows hit effect for 0.5 seconds, then transforms to falling.

  duck_hit:
    width: 35
    height: 41
    color: red
    sprite: green_hit
    behaviors:
      - lua: |
          local hit = {}
          function hit.on_spawn(entity_id)
              -- Award points when duck is hit
              ams.add_score(100)
              ams.play_sound("duck_hit")
          end
          return hit
    tags: [duck]
    on_update:
      - when:
          age: [0.5, null]  # After 0.5 seconds
        transform:
          type: duck_falling
    render:
      - shape: sprite
        sprite_name: green_hit

  # ---------------------------------------------------------------------------
  # Duck - Falling state
  # ---------------------------------------------------------------------------
  # Falls with gravity, destroyed when off screen.

  duck_falling:
    width: 22
    height: 41
    color: gray
    sprite: green_fall_1
    behaviors: [gravity]
    behavior_config:
      gravity:
        acceleration: 800
        destroy_offscreen: true
    tags: [duck]
    render:
      - shape: sprite
        sprite_name: green_fall_1

  # ---------------------------------------------------------------------------
  # Spawner - invisible entity that spawns ducks
  # ---------------------------------------------------------------------------

  spawner:
    width: 1
    height: 1
    color: black
    behaviors:
      - lua: |
          local spawner = {}

          function spawner.on_spawn(entity_id)
              ams.set_prop(entity_id, "spawn_timer", 0)
          end

          function spawner.on_update(entity_id, dt)
              local timer = ams.get_prop(entity_id, "spawn_timer") or 0
              timer = timer + dt

              local interval = ams.get_config(entity_id, "spawner", "interval", 2.0)
              local max_ducks = ams.get_config(entity_id, "spawner", "max_ducks", 3)

              if timer >= interval then
                  ams.set_prop(entity_id, "spawn_timer", timer - interval)

                  -- Count current ducks
                  local current = ams.count_entities_by_tag("duck")

                  if current < max_ducks then
                      -- Spawn a duck
                      local screen_w = ams.get_screen_width()
                      local screen_h = ams.get_screen_height()

                      -- Random edge spawn
                      local edge = math.floor(ams.random() * 3)
                      local x, y, vx, vy
                      local speed = ams.random_range(150, 300)

                      if edge == 0 then
                          -- Left edge
                          x = -40
                          y = ams.random_range(50, screen_h * 0.4)
                          vx = speed
                          vy = ams.random_range(-speed * 0.5, speed * 0.5)
                      elseif edge == 1 then
                          -- Right edge
                          x = screen_w + 10
                          y = ams.random_range(50, screen_h * 0.4)
                          vx = -speed
                          vy = ams.random_range(-speed * 0.5, speed * 0.5)
                      else
                          -- Bottom
                          x = ams.random_range(100, screen_w - 100)
                          y = screen_h * 0.7
                          vx = ams.random_range(-speed * 0.5, speed * 0.5)
                          vy = -speed
                      end

                      -- Use entity type defaults (0, 0 = use type config size)
                      ams.spawn("duck_flying", x, y, vx, vy, 0, 0, "", "")
                  end
              end

              ams.set_prop(entity_id, "spawn_timer", timer)
          end

          return spawner
    behavior_config:
      spawner:
        interval: 2.0
        max_ducks: 3
    tags: []
    render: []  # Invisible

# =============================================================================
# Input Mapping
# =============================================================================
# on_hit: fires when input position is INSIDE the entity bounds

input_mapping:
  duck_flying:
    on_hit:
      transform:
        type: duck_hit

# =============================================================================
# Collisions (none needed for DuckHunt - input-based)
# =============================================================================

collisions: []

# =============================================================================
# Player Configuration
# =============================================================================
# No player entity - this is a shooting gallery game

player:
  type: spawner
  spawn: [0, 0]

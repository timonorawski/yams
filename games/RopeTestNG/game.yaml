# yaml-language-server: $schema=../../schemas/game.schema.json
# Rope Test NG - Testing spring-based rope physics
#
# Uses rope_link behavior for elastic spring constraints instead of
# rigid follow_parent. This creates swinging/bouncing rope physics.

name: "Rope Test"
description: "Spring physics rope test"
version: "1.0.0"
author: "AMS Team"

screen_width: 800
screen_height: 600
background_color: [20, 20, 40]

defaults:
  lives: 99

win_condition: none

# =============================================================================
# Entity Types
# =============================================================================

entity_types:

  # ---------------------------------------------------------------------------
  # Anchor - fixed point (no movement)
  # ---------------------------------------------------------------------------
  anchor:
    width: 20
    height: 20
    color: [100, 100, 100]
    tags: [anchor]
    render:
      - shape: circle
        color: [100, 100, 100]
        radius: 0.5

  # ---------------------------------------------------------------------------
  # Rope Segment - spring-connected to parent
  # ---------------------------------------------------------------------------
  rope_segment:
    width: 8
    height: 25
    color: [139, 90, 43]
    behaviors: [rope_link]
    behavior_config:
      rope_link:
        rest_length: 28
        stiffness: 1200
        damping: 0.96
    tags: [rope, cuttable]
    render:
      - shape: rectangle
        color: [139, 90, 43]
    on_parent_destroy:
      type: falling_segment

  # ---------------------------------------------------------------------------
  # Falling Segment - detached, just gravity
  # ---------------------------------------------------------------------------
  falling_segment:
    width: 8
    height: 25
    color: [139, 90, 43]
    behaviors: [gravity, destroy_offscreen]
    behavior_config:
      gravity:
        acceleration: 600
      destroy_offscreen:
        edges: bottom
        margin: 50
    tags: [falling]
    render:
      - shape: rectangle
        color: [139, 90, 43]
    on_parent_destroy:
      type: falling_segment

  # ---------------------------------------------------------------------------
  # Candy - heavier, spring-connected, has gravity
  # ---------------------------------------------------------------------------
  candy:
    width: 40
    height: 40
    color: [255, 100, 100]
    behaviors: [gravity, rope_link]
    behavior_config:
      gravity:
        acceleration: 400
      rope_link:
        rest_length: 35
        stiffness: 800
        damping: 0.97
    tags: [candy, payload]
    render:
      - shape: circle
        color: [255, 100, 100]
        radius: 0.45
    on_parent_destroy:
      type: falling_candy

  # ---------------------------------------------------------------------------
  # Falling Candy - detached candy with gravity
  # ---------------------------------------------------------------------------
  falling_candy:
    width: 40
    height: 40
    color: [255, 100, 100]
    behaviors: [gravity]
    behavior_config:
      gravity:
        acceleration: 600
    tags: [candy, falling]
    render:
      - shape: circle
        color: [255, 100, 100]
        radius: 0.45

  # ---------------------------------------------------------------------------
  # Goal
  # ---------------------------------------------------------------------------
  goal:
    width: 100
    height: 60
    color: [100, 200, 100]
    tags: [goal]
    render:
      - shape: rectangle
        color: [80, 160, 80]
      - shape: circle
        color: [120, 220, 120]
        radius: 0.3

  # ---------------------------------------------------------------------------
  # Star - collectible
  # ---------------------------------------------------------------------------
  star:
    width: 30
    height: 30
    color: [255, 215, 0]
    points: 100
    tags: [star, collectible]
    render:
      - shape: circle
        color: [255, 215, 0]
        radius: 0.45
      - shape: circle
        color: [255, 255, 150]
        radius: 0.2

  # ---------------------------------------------------------------------------
  # Level Setup - spawns the test scene
  # ---------------------------------------------------------------------------
  level_setup:
    width: 1
    height: 1
    color: black
    behaviors:
      - lua: |
          local setup = {}

          function setup.on_spawn(entity_id)
              local screen_w = ams.get_screen_width()
              local screen_h = ams.get_screen_height()

              -- Spawn anchor at top center
              local anchor_x = screen_w / 2
              local anchor_y = 50
              local anchor_id = ams.spawn("anchor", anchor_x - 10, anchor_y - 10, 0, 0, 20, 20, "", "")

              -- Spawn rope chain
              local segment_count = 6
              local segment_height = 25
              local segment_gap = 5
              local prev_id = anchor_id
              local prev_y = anchor_y + 10

              for i = 1, segment_count do
                  local seg_y = prev_y + segment_gap
                  local seg_id = ams.spawn("rope_segment", anchor_x - 4, seg_y, 0, 0, 8, segment_height, "", "")
                  ams.set_parent(seg_id, prev_id, 0, segment_height / 2 + segment_gap)
                  prev_id = seg_id
                  prev_y = seg_y + segment_height
              end

              -- Spawn candy at end of rope
              local candy_y = prev_y + segment_gap + 20
              local candy_id = ams.spawn("candy", anchor_x - 20, candy_y, 0, 0, 40, 40, "", "")
              ams.set_parent(candy_id, prev_id, 0, segment_height / 2 + 30)

              -- Give candy initial sideways velocity for swinging
              ams.set_vx(candy_id, 150)

              -- Spawn goal
              ams.spawn("goal", screen_w / 2 - 50, screen_h - 80, 0, 0, 100, 60, "", "")

              -- Spawn a star
              ams.spawn("star", screen_w / 2 - 15, screen_h / 2, 0, 0, 30, 30, "", "")

              -- Self-destruct
              ams.destroy(entity_id)
          end

          return setup
    tags: []
    render: []

  # ---------------------------------------------------------------------------
  # Win Banner
  # ---------------------------------------------------------------------------
  win_banner:
    width: 300
    height: 80
    color: [100, 200, 100]
    tags: [ui, win]
    render:
      - shape: rectangle
        color: [50, 150, 50]
      - shape: text
        text: "SWEET!"
        color: white
        font_size: 48

# =============================================================================
# Input - click to cut rope
# =============================================================================

input_mapping:
  rope_segment:
    on_hit:
      transform:
        type: destroy

  falling_segment:
    on_hit:
      transform:
        type: destroy

# =============================================================================
# Collisions
# =============================================================================

collision_behaviors:
  falling_candy:
    goal:
      action:
        lua: |
          local action = {}
          function action.execute(candy_id, goal_id, modifier)
              ams.destroy(candy_id)
              local screen_w = ams.get_screen_width()
              ams.spawn("win_banner", screen_w / 2 - 150, 250, 0, 0, 300, 80, "", "")
              ams.play_sound("win")
          end
          return action

    star:
      action:
        lua: |
          local action = {}
          function action.execute(candy_id, star_id, modifier)
              ams.destroy(star_id)
              ams.add_score(100)
              ams.play_sound("star")
          end
          return action

  # Also check candy (while still attached) hitting stars
  candy:
    star:
      action:
        lua: |
          local action = {}
          function action.execute(candy_id, star_id, modifier)
              ams.destroy(star_id)
              ams.add_score(100)
              ams.play_sound("star")
          end
          return action

# =============================================================================
# Lose Conditions
# =============================================================================

lose_conditions:
  - entity_type: falling_candy
    event: exited_screen
    edge: bottom
    action: lose_life
    then:
      destroy: falling_candy

# =============================================================================
# Player Configuration
# =============================================================================

player:
  type: level_setup
  spawn: [0, 0]

default_layout:
  name: "Spring Rope Test"

# yaml-language-server: $schema=../../schemas/game.schema.json
# FruitSlice - Fruit Ninja-style game with arcing targets
#
# Core mechanics:
# - Fruits arc across screen in parabolic trajectories
# - Click to slice fruits for points
# - Avoid clicking bombs (lose life)
# - Combo system for consecutive hits

name: "Fruit Slice"
description: "Slice fruits as they arc across the screen"
version: "1.0.0"
author: "AMS Team"

screen_width: 800
screen_height: 600
background_color: [20, 20, 40]  # Dark blue-gray

defaults:
  lives: 3

win_condition: reach_score
win_target: 1000

# =============================================================================
# Entity Types
# =============================================================================

entity_types:

  # ---------------------------------------------------------------------------
  # Fruit - base type for all fruits
  # ---------------------------------------------------------------------------
  # Arcs across screen following parabolic path.
  # Click to slice and score points.

  fruit:
    width: 50
    height: 50
    behaviors: [gravity, destroy_offscreen]
    behavior_config:
      gravity:
        acceleration: 600
      destroy_offscreen:
        edges: all
        margin: 50
    tags: [fruit, target]
    render:
      - shape: circle
        color: $color
        radius: 0.5

  # Specific fruit types with different colors and points
  fruit_red:
    extends: fruit
    color: red
    points: 10

  fruit_orange:
    extends: fruit
    color: orange
    points: 15

  fruit_yellow:
    extends: fruit
    color: yellow
    points: 20

  fruit_green:
    extends: fruit
    color: green
    points: 25

  fruit_blue:
    extends: fruit
    color: blue
    points: 30

  fruit_golden:
    extends: fruit
    color: [255, 215, 0]  # Gold
    points: 100
    width: 60
    height: 60

  # ---------------------------------------------------------------------------
  # Bomb - avoid these!
  # ---------------------------------------------------------------------------

  bomb:
    width: 45
    height: 45
    color: [40, 40, 40]
    behaviors: [gravity, destroy_offscreen]
    behavior_config:
      gravity:
        acceleration: 600
      destroy_offscreen:
        edges: all
        margin: 50
    tags: [bomb, hazard]
    render:
      # Black body
      - shape: circle
        color: [40, 40, 40]
        radius: 0.5
      # Red warning glow (pulsing based on age)
      - shape: circle
        color: [200, 0, 0]
        radius: 0.35

  # ---------------------------------------------------------------------------
  # Slice effect - spawned when fruit is hit
  # ---------------------------------------------------------------------------

  slice_effect:
    width: 60
    height: 60
    behaviors: [gravity, fade_out]
    behavior_config:
      gravity:
        acceleration: 400
        destroy_offscreen: true
      fade_out:
        duration: 0.5
    tags: [effect]
    render:
      - shape: circle
        color: $color
        radius: 0.3
        alpha: $alpha

  # ---------------------------------------------------------------------------
  # Score popup - shows points earned
  # ---------------------------------------------------------------------------

  score_popup:
    width: 100
    height: 30
    behaviors:
      - lua: |
          local popup = {}
          function popup.on_spawn(entity_id)
              ams.set_prop(entity_id, "age", 0)
              ams.set_vy(entity_id, -50)  -- Float upward
          end
          function popup.on_update(entity_id, dt)
              local age = ams.get_prop(entity_id, "age") or 0
              age = age + dt
              ams.set_prop(entity_id, "age", age)
              -- Move up
              local y = ams.get_y(entity_id)
              y = y + ams.get_vy(entity_id) * dt
              ams.set_y(entity_id, y)
              -- Fade out and destroy after 1 second
              if age > 1.0 then
                  ams.destroy(entity_id)
              else
                  ams.set_prop(entity_id, "alpha", 255 * (1 - age))
              end
          end
          return popup
    tags: [effect]
    render:
      - shape: text
        text: $text
        color: white
        font_size: 24
        alpha: $alpha

  # ---------------------------------------------------------------------------
  # Spawner - spawns fruits and bombs
  # ---------------------------------------------------------------------------

  spawner:
    width: 1
    height: 1
    color: black
    behaviors:
      - lua: |
          local spawner = {}

          function spawner.on_spawn(entity_id)
              ams.set_prop(entity_id, "spawn_timer", 0)
              ams.set_prop(entity_id, "combo", 0)
              ams.set_prop(entity_id, "last_hit_time", 0)
          end

          function spawner.on_update(entity_id, dt)
              local timer = ams.get_prop(entity_id, "spawn_timer") or 0
              timer = timer + dt

              local interval = ams.get_config(entity_id, "spawner", "interval", 2.0)
              local bomb_ratio = ams.get_config(entity_id, "spawner", "bomb_ratio", 0.15)
              local max_targets = ams.get_config(entity_id, "spawner", "max_targets", 4)

              -- Check combo timeout (3 seconds)
              local combo_window = ams.get_config(entity_id, "spawner", "combo_window", 3.0)
              local last_hit = ams.get_prop(entity_id, "last_hit_time") or 0
              local game_time = ams.get_time()
              if game_time - last_hit > combo_window then
                  ams.set_prop(entity_id, "combo", 0)
              end

              if timer >= interval then
                  ams.set_prop(entity_id, "spawn_timer", timer - interval)

                  -- Count current fruits
                  local current = ams.count_entities_by_tag("fruit") + ams.count_entities_by_tag("bomb")

                  if current < max_targets then
                      local screen_w = ams.get_screen_width()
                      local screen_h = ams.get_screen_height()

                      -- Decide spawn side (left or right)
                      local from_left = ams.random() > 0.5
                      local x, vx

                      if from_left then
                          x = -30
                          vx = ams.random_range(150, 300)
                      else
                          x = screen_w + 30
                          vx = ams.random_range(-300, -150)
                      end

                      -- Spawn below screen, launch upward
                      local y = screen_h + 30

                      -- Calculate vy to reach apex between 100 and 70% of screen height
                      -- Using v^2 = 2*g*h, so v = sqrt(2*g*h)
                      local gravity = 600
                      local apex_height = ams.random_range(200, screen_h * 0.7)
                      local vy = -math.sqrt(2 * gravity * apex_height)

                      -- Choose fruit type or bomb
                      local entity_type
                      if ams.random() < bomb_ratio then
                          entity_type = "bomb"
                      else
                          -- Random fruit type
                          local fruits = {"fruit_red", "fruit_orange", "fruit_yellow", "fruit_green", "fruit_blue"}
                          -- Small chance for golden fruit
                          if ams.random() < 0.05 then
                              entity_type = "fruit_golden"
                          else
                              local idx = math.floor(ams.random() * #fruits) + 1
                              entity_type = fruits[idx]
                          end
                      end

                      ams.spawn(entity_type, x, y, vx, vy, 0, 0, "", "")
                  end
              end

              ams.set_prop(entity_id, "spawn_timer", timer)
          end

          return spawner
    behavior_config:
      spawner:
        interval: 1.5
        bomb_ratio: 0.15
        max_targets: 5
        combo_window: 3.0
    tags: []
    render: []

  # ---------------------------------------------------------------------------
  # Combo display - shows current combo multiplier
  # ---------------------------------------------------------------------------

  combo_display:
    width: 200
    height: 60
    behaviors:
      - lua: |
          local display = {}
          function display.on_update(entity_id, dt)
              -- Get combo from spawner
              local spawner_ids = ams.get_entities_of_type("spawner")
              local combo = 0
              if #spawner_ids > 0 then
                  combo = ams.get_prop(spawner_ids[1], "combo") or 0
              end
              ams.set_prop(entity_id, "combo", combo)
              -- Calculate alpha based on combo (fade when 0)
              local alpha = combo > 0 and 255 or 0
              ams.set_prop(entity_id, "alpha", alpha)
          end
          return display
    tags: [ui]
    render:
      - shape: text
        text: "{combo}x COMBO"
        color: [255, 200, 0]
        font_size: 36
        alpha: $alpha
        when:
          property: combo
          compare: greater_than
          value: 0

# =============================================================================
# Input Mapping
# =============================================================================

# Global input - plays slice sound on any click
global_on_input:
  action: play_sound
  action_args:
    sound: slice

input_mapping:
  # Clicking on fruit slices it
  fruit_red:
    on_hit:
      transform:
        type: destroy
  fruit_orange:
    on_hit:
      transform:
        type: destroy
  fruit_yellow:
    on_hit:
      transform:
        type: destroy
  fruit_green:
    on_hit:
      transform:
        type: destroy
  fruit_blue:
    on_hit:
      transform:
        type: destroy
  fruit_golden:
    on_hit:
      transform:
        type: destroy

  # Clicking on bomb - lose life
  bomb:
    on_hit:
      transform:
        type: destroy

# =============================================================================
# Collisions (none needed - input-based)
# =============================================================================

collisions: []

# =============================================================================
# Lose Conditions
# =============================================================================

lose_conditions:
  - entity_type: bomb
    event: destroyed
    action: lose_life

# =============================================================================
# Player Configuration (spawner + combo display)
# =============================================================================

player:
  type: spawner
  spawn: [0, 0]

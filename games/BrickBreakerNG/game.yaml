# BrickBreaker NextGen - Game Definition
#
# This YAML defines all entity types, their behaviors, and game rules.
# Levels reference these entity types by name.
#
# Entity types can extend other types using the 'extends' field.
# The base_type is preserved for win condition checking.

name: "Brick Breaker NG"
description: "Lua behavior-driven brick breaker"
version: "1.0.0"
author: "AMS Team"

screen_width: 800
screen_height: 600
background_color: [20, 20, 30]

# Default game settings (can be overridden via CLI)
defaults:
  lives: 3

# Win/lose conditions
win_condition: destroy_all
win_target_type: brick  # Win when all entities with base_type 'brick' destroyed
lose_on_player_death: true

# =============================================================================
# Assets
# =============================================================================
# Sound and sprite mappings. Names used in Lua behaviors map to file paths.
# Paths are relative to games/BrickBreakerNG/assets/

assets:
  sounds:
    # Ball/paddle sounds
    paddle_hit: sounds/paddle_hit.wav
    wall_bounce: sounds/wall_bounce.wav

    # Brick sounds
    brick_hit: sounds/brick_hit.wav
    brick_break: sounds/brick_break.wav

    # Shooter/projectile sounds
    shoot: sounds/shoot.wav
    player_hit: sounds/player_hit.wav

  sprites: {}
    # Add sprite mappings here when using classic skin
    # paddle: sprites/paddle.png
    # ball: sprites/ball.png

# =============================================================================
# Entity Type Definitions
# =============================================================================
# Each type defines default properties and attached behaviors.
# Levels can override any property when spawning.
# Types can use 'extends' to inherit from a base type.

entity_types:

  # ---------------------------------------------------------------------------
  # Player entities
  # ---------------------------------------------------------------------------

  # paddle_ready: Composite entity that looks like paddle+ball, transforms on input
  # This is the "waiting to launch" state. Extends paddle so collisions work.
  paddle_ready:
    extends: paddle
    tags: [player]  # Override tags to keep player tag
    render:
      # Paddle body
      - shape: rectangle
        color: blue
        fill: true
      - shape: rectangle
        color: white
        fill: false
        line_width: 2
      # Attached ball (centered above)
      - shape: circle
        color: white
        fill: true
        offset: [52, -20]  # center of paddle width, above
        size: [16, 16]

  # paddle: Active paddle (after ball is launched)
  paddle:
    width: 120
    height: 15
    color: blue
    behaviors: [paddle]
    behavior_config:
      paddle:
        speed: 500
        stop_threshold: 1.0
    tags: [player]
    render:
      - shape: rectangle
        color: blue
        fill: true
      - shape: rectangle
        color: white
        fill: false
        line_width: 2

  # ball: Active ball in play
  ball:
    width: 16
    height: 16
    color: white
    behaviors: [ball]
    behavior_config:
      ball:
        speed: 300
        max_speed: 600
        speed_increase: 5
    tags: [ball]
    render:
      - shape: circle
        color: white
        fill: true

  # ---------------------------------------------------------------------------
  # Base brick type (extended by specific colors)
  # ---------------------------------------------------------------------------

  brick:
    width: 70
    height: 25
    color: gray
    behaviors: [brick]
    behavior_config:
      brick:
        hits: 1
        points: 100
    tags: [enemy, brick]
    render:
      # Base brick fill
      - shape: rectangle
        color: $color  # Uses entity.color
        fill: true
      # Outline
      - shape: rectangle
        color: white
        fill: false
        line_width: 1
      # Damage overlay - darkens brick based on damage taken
      - shape: rectangle
        color: black
        fill: true
        alpha: $damage_ratio  # 0 when undamaged, approaches 1 as damaged
        when:
          property: brick_max_hits
          compare: greater_than
          value: 1
      # Hit count text - only for multi-hit bricks
      - shape: text
        text: $brick_hits_remaining
        color: white
        font_size: 20
        align: center
        when:
          property: brick_max_hits
          compare: greater_than
          value: 1

  # ---------------------------------------------------------------------------
  # Basic bricks (single hit, different colors/points)
  # Extend from 'brick' base type
  # ---------------------------------------------------------------------------

  brick_red:
    extends: brick
    color: red
    behavior_config:
      brick:
        points: 500

  brick_orange:
    extends: brick
    color: orange
    behavior_config:
      brick:
        points: 400

  brick_yellow:
    extends: brick
    color: yellow
    behavior_config:
      brick:
        points: 300

  brick_green:
    extends: brick
    color: green
    behavior_config:
      brick:
        points: 200

  brick_blue:
    extends: brick
    color: blue
    behavior_config:
      brick:
        points: 100

  # ---------------------------------------------------------------------------
  # Multi-hit bricks
  # ---------------------------------------------------------------------------

  brick_gray:
    extends: brick
    color: gray
    behavior_config:
      brick:
        hits: 2
        points: 200

  brick_silver:
    extends: brick
    color: silver
    behavior_config:
      brick:
        hits: 3
        points: 400

  # ---------------------------------------------------------------------------
  # Space Invaders style bricks (extend brick, add movement behaviors)
  # ---------------------------------------------------------------------------

  invader:
    extends: brick
    color: green
    behaviors: [brick, descend]
    behavior_config:
      brick:
        points: 150
      descend:
        speed: 15
        pattern: fixed

  invader_oscillating:
    extends: brick
    color: cyan
    behaviors: [brick, descend, oscillate]
    behavior_config:
      brick:
        points: 200
      descend:
        speed: 15
        pattern: fixed
      oscillate:
        speed: 40
        range: 30

  invader_shooter:
    extends: brick
    color: purple
    behaviors: [brick, descend, shoot]
    behavior_config:
      brick:
        hits: 2
        points: 500
      descend:
        speed: 10
        pattern: fixed
      shoot:
        interval: 3.0
        projectile_speed: 200
        direction: down
    tags: [enemy, brick, shooter]
    render:
      # Base brick
      - shape: rectangle
        color: $color
        fill: true
      - shape: rectangle
        color: white
        fill: false
        line_width: 1
      # Shooter indicator (triangle at bottom pointing down)
      - shape: triangle
        color: yellow
        fill: true
        points: [[0.3, 0.8], [0.7, 0.8], [0.5, 1.3]]

  # ---------------------------------------------------------------------------
  # Indestructible/special bricks
  # ---------------------------------------------------------------------------

  brick_indestructible:
    width: 70
    height: 25
    color: white
    behaviors: [brick]
    behavior_config:
      brick:
        hits: 1
        indestructible: true
        points: 0
    tags: [brick]  # Not tagged as enemy - won't count for win
    render:
      - shape: rectangle
        color: $color
        fill: true
      # X pattern to indicate indestructible
      - shape: line
        color: gray
        line_width: 2
        points: [[0.1, 0.1], [0.9, 0.9]]
      - shape: line
        color: gray
        line_width: 2
        points: [[0.9, 0.1], [0.1, 0.9]]

  # ---------------------------------------------------------------------------
  # Projectiles
  # ---------------------------------------------------------------------------

  projectile:
    width: 8
    height: 8
    color: red
    behaviors: [projectile]
    tags: [projectile, hazard]
    render:
      - shape: circle
        color: red
        fill: true

# =============================================================================
# Collision Behaviors
# =============================================================================
# Defines what happens when entity types collide.
# Format: collision_behaviors[entity_a][entity_b] = action to take
#
# The action is executed on entity_a when it collides with entity_b.
# Both sides can have separate actions (ball hitting brick vs brick being hit).

collision_behaviors:
  # Ball colliding with paddle
  ball:
    paddle:
      action: bounce_paddle
      modifier:
        max_angle: 60

    # Ball colliding with brick - bounce off it
    brick:
      action: bounce_reflect
      modifier:
        speed_increase: 5
        max_speed: 600

  # Brick being hit by ball - take damage
  brick:
    ball:
      action: take_damage
      modifier:
        amount: 1

  # Projectile hitting paddle - damages player
  projectile:
    paddle:
      action: hit_player
      modifier:
        play_sound: player_hit

# =============================================================================
# Collision Rules (for collision detection)
# =============================================================================
# Defines which types can collide - detection only.
# collision_behaviors above define what happens.

collisions:
  - [ball, paddle]
  - [ball, brick]
  - [projectile, paddle]

# =============================================================================
# Input Mapping
# =============================================================================
# Maps input to entity types. Supports:
# - target_x/target_y: Set property from input position
# - on_input.transform: Transform entity on input
# - on_input.when: Condition for transform

input_mapping:
  # paddle_ready transforms into paddle + ball on input
  paddle_ready:
    target_x: paddle_target_x
    on_input:
      transform:
        into: paddle
        spawn:
          - type: ball
            offset: [52, -20]  # Center of paddle (120/2 - 8), above paddle
            speed: 300         # Spawn property: ball behavior converts to velocity
            angle:             # Spawn property: {lua: ...} evaluated at spawn time
              lua: ams.random_range(-120, -60)

  # Active paddle just moves to target
  paddle:
    target_x: paddle_target_x

# =============================================================================
# Lose Conditions
# =============================================================================
# Defines events that cause life loss and subsequent actions.

lose_conditions:
  - entity_type: ball
    event: exited_screen
    edge: bottom
    action: lose_life
    then:
      destroy: ball
      transform:
        entity_type: paddle
        into: paddle_ready

  # Projectile hitting paddle causes life loss
  - entity_type: paddle
    event: property_true
    property: was_hit
    action: lose_life
    then:
      clear_property: was_hit
      destroy: ball
      transform:
        entity_type: paddle
        into: paddle_ready

# =============================================================================
# Player Configuration
# =============================================================================

player:
  type: paddle_ready  # Start with paddle_ready (ball attached)
  spawn: [340, 550]  # x, y position

# =============================================================================
# Default Layout (used when no level specified)
# =============================================================================
# This creates the classic 5-row brick layout

default_layout:
  ball_spawn: [392, 525]
  brick_grid:
    start_x: 65
    start_y: 60
    cols: 10
    rows: 5
    # Row patterns: which entity type for each row (bottom to top visually)
    row_types:
      - brick_blue
      - brick_green
      - brick_yellow
      - brick_orange
      - brick_red

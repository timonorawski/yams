# yaml-language-server: $schema=../lua_script.schema.json
type: collision_action
name: take_damage
description: |
  Reduces entity_a's hit points when colliding with entity_b.
  Destroys entity_a and awards points when hits reach zero.
version: "1.0"
tags: [combat, destruction]

config:
  amount:
    type: int
    description: Damage amount per hit
    default: 1
    min: 1
  points:
    type: int
    description: Points awarded on destroy (overrides brick config)
  hit_sound:
    type: string
    description: Sound to play on hit
    default: brick_hit
  destroy_sound:
    type: string
    description: Sound to play on destroy
    default: brick_break

provides:
  hooks:
    - execute

requires:
  behaviors:
    - brick
  properties:
    - brick_hits_remaining
  api:
    - get_config
    - get_prop
    - set_prop
    - add_score
    - destroy
    - play_sound

examples:
  - title: Basic brick damage
    yaml: |
      collision_behaviors:
        brick:
          ball:
            action: take_damage
            modifier:
              amount: 1

  - title: Custom sounds and points
    yaml: |
      collision_behaviors:
        crystal:
          projectile:
            action: take_damage
            modifier:
              amount: 2
              points: 500
              hit_sound: crystal_crack
              destroy_sound: crystal_shatter

lua: |
  local take_damage = {}

  function take_damage.execute(entity_a_id, entity_b_id, modifier)
      -- Check if entity is indestructible
      local indestructible = ams.get_config(entity_a_id, "brick", "indestructible", false)
      if indestructible then
          local hit_sound = "brick_hit"
          if modifier and modifier.hit_sound then
              hit_sound = modifier.hit_sound
          end
          ams.play_sound(hit_sound)
          return
      end

      -- Get current hits remaining
      local hits = ams.get_prop(entity_a_id, "brick_hits_remaining") or 1

      -- Get damage amount
      local damage = 1
      if modifier and modifier.amount then
          damage = modifier.amount
      end

      -- Apply damage
      hits = hits - damage
      ams.set_prop(entity_a_id, "brick_hits_remaining", hits)

      if hits <= 0 then
          -- Destroyed
          local points = ams.get_config(entity_a_id, "brick", "points", 100)
          if modifier and modifier.points then
              points = modifier.points
          end

          ams.add_score(points)
          ams.destroy(entity_a_id)

          local destroy_sound = "brick_break"
          if modifier and modifier.destroy_sound then
              destroy_sound = modifier.destroy_sound
          end
          ams.play_sound(destroy_sound)
      else
          -- Damaged but not destroyed
          local hit_sound = "brick_hit"
          if modifier and modifier.hit_sound then
              hit_sound = modifier.hit_sound
          end
          ams.play_sound(hit_sound)
      end
  end

  return take_damage

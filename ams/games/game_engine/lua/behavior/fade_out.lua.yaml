# yaml-language-server: $schema=../lua_script.schema.json
type: behavior
name: fade_out
description: |
  Fade out and destroy entity after a duration.

  Sets alpha property from 255 to 0 over the configured duration,
  then destroys the entity.
version: "1.0"
tags: [visual, lifecycle]

config:
  duration:
    type: float
    description: Fade duration in seconds
    default: 0.5
    min: 0

provides:
  hooks:
    - on_spawn
    - on_update
  properties:
    - alpha
    - fade_duration
    - fade_timer

requires:
  api: [get_config, get_prop, set_prop, destroy]

examples:
  - title: Quick fade
    yaml: |
      behaviors: [fade_out]
      behavior_config:
        fade_out:
          duration: 0.3

  - title: Slow fade
    yaml: |
      behaviors: [fade_out]
      behavior_config:
        fade_out:
          duration: 2.0

lua: |
  local behavior = {}

  function behavior.on_spawn(entity_id)
      -- Set initial alpha if not already set
      local alpha = ams.get_prop(entity_id, "alpha")
      if not alpha then
          ams.set_prop(entity_id, "alpha", 255)
      end

      -- Get duration from config, default 0.5 seconds
      local duration = ams.get_config(entity_id, "fade_out", "duration", 0.5)
      ams.set_prop(entity_id, "fade_duration", duration)
      ams.set_prop(entity_id, "fade_timer", 0)
  end

  function behavior.on_update(entity_id, dt)
      local timer = ams.get_prop(entity_id, "fade_timer") or 0
      local duration = ams.get_prop(entity_id, "fade_duration") or 0.5

      timer = timer + dt
      ams.set_prop(entity_id, "fade_timer", timer)

      -- Calculate alpha based on progress
      local progress = timer / duration
      if progress >= 1.0 then
          -- Fully faded, destroy
          ams.destroy(entity_id)
      else
          -- Set alpha (255 to 0)
          local alpha = math.floor(255 * (1.0 - progress))
          ams.set_prop(entity_id, "alpha", alpha)
      end
  end

  return behavior

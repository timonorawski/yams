# yaml-language-server: $schema=../lua_script.schema.json
type: behavior
name: shoot
description: |
  Entity fires projectiles at intervals.

  Spawns projectiles with configurable direction, speed, and timing.
version: "1.0"
tags: [game, enemy]

config:
  interval:
    type: float
    description: Seconds between shots
    default: 2.0
    min: 0
  projectile_type:
    type: string
    description: Entity type to spawn
    default: "projectile"
  projectile_speed:
    type: float
    description: Projectile velocity
    default: 200
    min: 0
  projectile_color:
    type: string
    description: Projectile color
    default: "red"
  direction:
    type: string
    description: Firing direction
    default: "down"
    enum: ["down", "up", "left", "right", "player"]
  offset_x:
    type: float
    description: Spawn offset from center X
    default: 0
  offset_y:
    type: float
    description: Spawn offset from center Y
    default: 0

provides:
  hooks:
    - on_spawn
    - on_update

requires:
  api: [get_config, get_prop, set_prop, get_x, get_y, get_width, get_height, spawn, play_sound, random]

examples:
  - title: Slow downward shooter
    yaml: |
      behaviors: [shoot]
      behavior_config:
        shoot:
          interval: 3.0
          projectile_speed: 150
          direction: down

  - title: Fast upward shooter
    yaml: |
      behaviors: [shoot]
      behavior_config:
        shoot:
          interval: 0.5
          projectile_speed: 400
          direction: up

lua: |
  local shoot = {}

  function shoot.on_spawn(entity_id)
      -- Start with random offset so not all shoot at once
      local interval = ams.get_config(entity_id, "shoot", "interval", 2.0)
      local initial_timer = ams.random() * interval
      ams.set_prop(entity_id, "shoot_timer", initial_timer)
  end

  function shoot.on_update(entity_id, dt)
      local interval = ams.get_config(entity_id, "shoot", "interval", 2.0)

      local timer = ams.get_prop(entity_id, "shoot_timer") or 0
      timer = timer + dt

      if timer >= interval then
          shoot.fire(entity_id)
          timer = timer - interval
      end

      ams.set_prop(entity_id, "shoot_timer", timer)
  end

  function shoot.fire(entity_id)
      local projectile_type = ams.get_config(entity_id, "shoot", "projectile_type", "projectile")
      local speed = ams.get_config(entity_id, "shoot", "projectile_speed", 200)
      local color = ams.get_config(entity_id, "shoot", "projectile_color", "red")
      local direction = ams.get_config(entity_id, "shoot", "direction", "down")
      local offset_x = ams.get_config(entity_id, "shoot", "offset_x", 0)
      local offset_y = ams.get_config(entity_id, "shoot", "offset_y", 0)

      -- Get entity center
      local x = ams.get_x(entity_id) + ams.get_width(entity_id) / 2
      local y = ams.get_y(entity_id) + ams.get_height(entity_id) / 2

      -- Apply offset
      x = x + offset_x
      y = y + offset_y

      -- Calculate velocity based on direction
      local vx, vy = 0, 0

      if direction == "down" then
          vy = speed
      elseif direction == "up" then
          vy = -speed
      elseif direction == "left" then
          vx = -speed
      elseif direction == "right" then
          vx = speed
      elseif direction == "player" then
          -- TODO: Find player entity and aim at it
          -- For now, just shoot down
          vy = speed
      end

      -- Spawn projectile
      local proj_id = ams.spawn(
          projectile_type,
          x - 4,  -- Center the 8x8 projectile
          y,
          vx, vy,
          8, 8,   -- width, height
          color,
          ""      -- sprite
      )

      ams.play_sound("shoot")
  end

  return shoot

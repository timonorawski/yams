# yaml-language-server: $schema=../lua_script.schema.json
type: behavior
name: descend
description: |
  Move entity downward with optional patterns.

  Supports fixed speed, step-based, or wave motion patterns.
version: "1.0"
tags: [motion, enemy]

config:
  speed:
    type: float
    description: Pixels per second
    default: 50
    min: 0
  pattern:
    type: string
    description: Movement pattern
    default: "fixed"
    enum: ["fixed", "step", "wave"]
  step_interval:
    type: float
    description: Seconds between steps for step pattern
    default: 1.0
    min: 0
  step_distance:
    type: float
    description: Pixels per step
    default: 20
  wave_amplitude:
    type: float
    description: Horizontal wave amplitude
    default: 30
  wave_frequency:
    type: float
    description: Oscillations per second
    default: 1.0

provides:
  hooks:
    - on_spawn
    - on_update

requires:
  api: [get_config, get_prop, set_prop, get_x, get_y, set_x, set_y, get_time, sin]

examples:
  - title: Simple descent
    yaml: |
      behaviors: [descend]
      behavior_config:
        descend:
          speed: 30

  - title: Wave pattern
    yaml: |
      behaviors: [descend]
      behavior_config:
        descend:
          speed: 40
          pattern: wave
          wave_amplitude: 50

lua: |
  local descend = {}

  function descend.on_spawn(entity_id)
      -- Initialize state
      ams.set_prop(entity_id, "descend_timer", 0)
      ams.set_prop(entity_id, "descend_start_x", ams.get_x(entity_id))
  end

  function descend.on_update(entity_id, dt)
      local speed = ams.get_config(entity_id, "descend", "speed", 50)
      local pattern = ams.get_config(entity_id, "descend", "pattern", "fixed")

      if pattern == "fixed" then
          -- Simple downward movement
          local y = ams.get_y(entity_id)
          ams.set_y(entity_id, y + speed * dt)

      elseif pattern == "step" then
          -- Move in discrete steps
          local interval = ams.get_config(entity_id, "descend", "step_interval", 1.0)
          local step_dist = ams.get_config(entity_id, "descend", "step_distance", 20)

          local timer = ams.get_prop(entity_id, "descend_timer") or 0
          timer = timer + dt

          if timer >= interval then
              local y = ams.get_y(entity_id)
              ams.set_y(entity_id, y + step_dist)
              timer = timer - interval
          end

          ams.set_prop(entity_id, "descend_timer", timer)

      elseif pattern == "wave" then
          -- Descend with horizontal wave motion
          local amplitude = ams.get_config(entity_id, "descend", "wave_amplitude", 30)
          local frequency = ams.get_config(entity_id, "descend", "wave_frequency", 1.0)
          local start_x = ams.get_prop(entity_id, "descend_start_x") or ams.get_x(entity_id)

          -- Move down
          local y = ams.get_y(entity_id)
          ams.set_y(entity_id, y + speed * dt)

          -- Oscillate horizontally
          local time = ams.get_time()
          local offset = amplitude * ams.sin(time * frequency * 2 * 3.14159)
          ams.set_x(entity_id, start_x + offset)
      end
  end

  return descend
